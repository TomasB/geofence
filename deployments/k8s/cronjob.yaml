apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: geofence-mmdb-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: standard  # Adjust based on your cluster's storage classes

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: geofence-mmdb-updater
spec:
  # Run daily at 3 AM UTC (adjust timezone as needed)
  schedule: "0 3 * * *"
  
  # Keep last 3 successful and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  
  # Maximum time allowed for update job (15 minutes)
  jobTemplate:
    spec:
      activeDeadlineSeconds: 900
      
      template:
        metadata:
          labels:
            app: geofence-mmdb-updater
        spec:
          restartPolicy: OnFailure
          
          volumes:
            - name: mmdb-data
              persistentVolumeClaim:
                claimName: geofence-mmdb-pvc
          
          containers:
            - name: geoipupdate
              image: maxmindinc/geoipupdate:v6.0
              
              env:
                # MaxMind Account ID from Secret
                - name: GEOIPUPDATE_ACCOUNT_ID
                  valueFrom:
                    secretKeyRef:
                      name: geofence-secret
                      key: MAXMIND_ACCOUNT_ID
                
                # MaxMind License Key from Secret
                - name: GEOIPUPDATE_LICENSE_KEY
                  valueFrom:
                    secretKeyRef:
                      name: geofence-secret
                      key: MAXMIND_LICENSE_KEY
                
                # Database edition to download
                - name: GEOIPUPDATE_EDITION_IDS
                  value: GeoLite2-Country
                
                # Target directory for MMDB file
                - name: GEOIPUPDATE_DB_DIR
                  value: /data
                
                # Enable verbose logging for troubleshooting
                - name: GEOIPUPDATE_VERBOSE
                  value: "1"
              
              volumeMounts:
                - name: mmdb-data
                  mountPath: /data
              
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
